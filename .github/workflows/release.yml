name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-*"

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false # never cancel an in-flight release

jobs:
  ci:
    name: CI (${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        node-version: ["20", "22", "24"]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        if: matrix.node-version == '22'
        run: pnpm typecheck

      - name: Test
        run: pnpm test

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: write # required to create GitHub Releases
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history for release notes

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Set version from tag
        # Strip 'v' prefix so v1.2.3 → 1.2.3, matching what will be published
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          pnpm version "$TAG" --no-git-tag-version --allow-same-version

      - name: Pack
        # Creates rzyns-temporal-fns-{version}.tgz — the exact file npm/pnpm
        # can install directly via URL, no registry auth required.
        run: pnpm pack

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: "*.tgz"
          # generates release notes from PRs merged since last tag
          # and marks anything like v1.0.0-beta.1 as a pre-release
